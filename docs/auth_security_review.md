# Authentication Security Review

## Environment variable safety

- Only the **anon key** lives in the frontend (`REACT_APP_SUPABASE_ANON_KEY`, `REACT_APP_SUPABASE_URL`). Never reference service-role secrets in React/JS bundles.
- The **service_role key** (used server-side for Supabase JWT introspection) must live in `server/.env.example` and real deployments should keep it in vaults or env vars inaccessible to the browser.
- R2 credentials (access & secret) are backend-only; the frontend reads from the public URLs that the backend returns, never storing keys in localStorage or logs.
- Ensure `BACKEND_BASE_URL` / `REACT_APP_API_BASE_URL` are set to production endpoints before deploying, and avoid logging tokens or session secrets during startup.

## Auth middleware hardening

- Confirm middleware strictly checks `Authorization` headers matching `Bearer <token>` and rejects invalid Supabase JWTs.
- Reject malformed, empty, expired, rotated, or invalid tokens with `401` and zero payload exposure.
- Wrap **all protected routes** (photo API, `/api/v1/profile`, etc.) with `@jwt_required` so every entry point triggers validation.

## Frontend session safety

- Sessions live in `localStorage`, so document that this area is susceptible to XSS; keep third-party scripts minimal and sanitize inputs.
- `logout()` clears both `localStorage` keys and the in-memory context, ensuring future requests lack tokens.
- AuthGuard redirects to `/login` whenever `user` is missing so protected pages cannot mount without a session.

## Supabase security best practices

- Enable **Row-Level Security (RLS)** on every table exposed to clients (photos/users). Keep policies scoped and avoid `ALLOW ALL`.
- Documented RLS policies ensure users only read/insert their own rows; service roles are the only path for admin operations.
- Keep Supabase policies versioned with the repo so that deployments audit the exact rules in place (e.g., via SQL migrations or Supabase UI exports).

## R2 access review

- Upload/delete routes call R2 via backend services (`R2StorageService`, `R2Client`)—never expose R2 keys in frontend bundles.
- The frontend consumes only the public URLs generated by R2; if the R2 bucket toggles to private, ensure signed URLs are still produced server-side.
- Document bucket settings in ops runbooks so developers don’t accidentally widen ACLs.

## CORS configuration review

- Allowed origins default to local dev ports, but production deploys must add the real frontend domain via `FRONTEND_ORIGIN`. Avoid wildcard origins.
- When adding new origins, update `docs/authentication.md` and `.env.example` instructions so future contributors know which env variable to tweak.
- Always pair CORS with authentication (don’t rely solely on CORS for security) and avoid echoing sensitive headers in error responses.
